# JournalLink Privacy Architecture

This document describes JournalLink's privacy-first design principles and implementation details.

## Core Principles

### 1. Local-First by Default
All user data is stored exclusively on the device unless the user explicitly opts into cloud features.

```
┌─────────────────────────────────────────────────────────────┐
│                      User's Device                          │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   SQLite    │  │ Filesystem  │  │    SecureStore      │ │
│  │             │  │             │  │                     │ │
│  │ - metadata  │  │ - images    │  │ - device ID         │ │
│  │ - tags      │  │ - PDFs      │  │ - API keys (opt)    │ │
│  │ - sessions  │  │ - audio     │  │                     │ │
│  │ - signals   │  │ - video     │  │                     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│                                                             │
│                    ↕ NEVER leaves device by default ↕       │
└─────────────────────────────────────────────────────────────┘
```

### 2. Consent at Every Step

No data is shared without explicit, informed consent:

| Action | Consent Required |
|--------|------------------|
| Store locally | Implicit (app usage) |
| Start BLE advertising | Explicit toggle |
| Pair with another device | Explicit confirmation |
| Select items to share | Item-by-item selection |
| Send to cloud AI | Explicit confirmation + disclosure |

### 3. Data Minimization

When sharing (sync or cloud AI), only the minimum necessary data is transmitted:

| Share Level | What's Sent |
|-------------|-------------|
| Title only | Item title (may be truncated) |
| Snippet | Title + first 100 chars of content |
| Full | Title + full content (redacted) |

### 4. No Logging of Sensitive Content

The app NEVER logs the following to console or crash reports:

- Raw journal text content
- URLs (source_url field)
- Extracted text from documents
- File paths with identifiable names
- Tag names (may reveal interests)
- AI responses containing personal data

**Allowed to log:**
- Item IDs (UUIDs, non-identifiable)
- Item types (text, image, etc.)
- Counts and statistics
- Error messages (without content)
- Operation success/failure

## Compare Capsule (Data Minimization)

When syncing with another user, JournalLink builds a "Compare Capsule" with minimal data:

```
Original Data (on device):
┌──────────────────────────────────────────────────────────┐
│ MediaItem: "My thoughts on career change"               │
│ Content: "I've been thinking about leaving my job at    │
│          Acme Corp. My boss John said..."               │
│ Tags: [career, work, decisions, personal]               │
│ URL: https://linkedin.com/myprofile                     │
└──────────────────────────────────────────────────────────┘

Compare Capsule (minimized):
┌──────────────────────────────────────────────────────────┐
│ Title: "Thoughts on career change" (truncated)          │
│ Snippet: "Thinking about career transition..." (100ch)  │
│ Tags: [career, work, decisions]  (top 3 only)           │
│ Redactions: [company name], [person name]               │
│ NO URL included                                         │
└──────────────────────────────────────────────────────────┘
```

### Redaction Pipeline (Future)

```
Raw Content
    │
    ▼
┌─────────────────┐
│ PII Detection   │  Detect names, emails, phones, addresses
├─────────────────┤
│ Entity Redact   │  [PERSON], [EMAIL], [PHONE], [COMPANY]
├─────────────────┤
│ URL Stripping   │  Remove all URLs
├─────────────────┤
│ Truncation      │  Limit to snippet length
└────────┬────────┘
         │
         ▼
   Minimized Capsule
```

## Device Identification

JournalLink generates a random UUID as device ID on first launch:

```typescript
// Stored in SecureStore (encrypted by OS)
deviceId = uuidv4();  // e.g., "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
```

This ID is:
- Random, not derived from hardware
- Stored only in SecureStore (not accessible to other apps)
- Used only for BLE handshake identification
- Never transmitted to any server
- Can be regenerated by reinstalling app

## BLE/QR Sync Privacy

### Pairing Flow Security

```
Device A                                Device B
    │                                       │
    ├───── Generate compressed signature ───┤
    │      (topTags, avgEmbed, deviceId)    │
    │                                       │
    │◄──────── QR code / BLE beacon ───────►│
    │                                       │
    ├───────── Mutual confirmation ─────────┤
    │      (both users tap "Connect")       │
    │                                       │
    ├───────── Consent gate UI ─────────────┤
    │      (select what to share)           │
    │                                       │
    ├───────── Exchange capsules ───────────┤
    │      (minimized, redacted)            │
    │                                       │
    └───────────────────────────────────────┘
```

### What's in the BLE Advertisement

| Field | Size | Privacy |
|-------|------|---------|
| Service UUID | 16 bytes | Static, app identifier |
| Device ID (truncated) | 8 bytes | Random, per-device |
| Signature hash | 4 bytes | Non-reversible |

The full signature is only exchanged after pairing confirmation.

## Cloud AI Privacy (Opt-In Only)

### When Cloud AI is Disabled (Default)

- No network requests to AI providers
- Insights generated locally using mock/heuristic methods
- Zero data leaves device

### When Cloud AI is Enabled

1. **User provides own API key**
   - Key stored in SecureStore (encrypted)
   - Never transmitted except to that provider
   - User can delete at any time

2. **Clear disclosure before each request**
   ```
   ┌────────────────────────────────────────┐
   │  Send to OpenAI?                       │
   │                                        │
   │  This will send:                       │
   │  • 5 item snippets (100 chars each)    │
   │  • 12 tag names                        │
   │  • Similarity score                    │
   │                                        │
   │  [Cancel]              [Send]          │
   └────────────────────────────────────────┘
   ```

3. **Request minimization**
   - Only Compare Capsule sent (never full vault)
   - Redactions applied before transmission
   - Request includes only what's needed for insight

4. **No storage on cloud**
   - We don't operate servers (user's own API key)
   - Provider's data retention applies (not ours)
   - Recommend reviewing provider's privacy policy

## API Keys Storage

API keys are stored in `expo-secure-store`:

| Platform | Storage |
|----------|---------|
| iOS | Keychain (encrypted) |
| Android | Keystore (encrypted) |
| Web | NOT SUPPORTED (no SecureStore) |

Keys are:
- Never logged
- Never transmitted except to their provider
- Deletable by user at any time
- Not backed up to iCloud/Google (depending on settings)

## Data Deletion

### Item Deletion
- SQLite record deleted
- Associated file deleted from filesystem
- Tag relationships cascade-deleted
- Swipe signals deleted

### Full Reset
User can delete all data via Settings:
1. Close SQLite connection
2. Delete database file
3. Clear all SecureStore keys
4. Delete all files in app documents directory

## Session History

Compare sessions are logged locally for user's reference:

```
compare_sessions table:
- id: session UUID
- mode: friend/heart
- scope_filters: JSON (what was compared)
- provider: null (local) or "openai" etc.
- created_at: timestamp

compare_session_items table:
- session_id, item_id, share_level
```

Users can:
- View past sessions
- See what was shared in each
- Delete session records

## Audit Logging (Future)

For transparency, future versions may include a privacy audit log:

| Event | Logged Data |
|-------|-------------|
| BLE sync started | timestamp, device hash |
| Items shared | count, share levels |
| Cloud AI request | provider, capsule size |
| Data deletion | item count |

This log would be:
- Local only
- Viewable by user
- Deletable by user

## Implementation Checklist

### Code Review Reminders

- [ ] No `console.log` of item content, URLs, or text
- [ ] No `console.log` of tag names
- [ ] No crash reporter captures of content fields
- [ ] All API keys use SecureStore, not AsyncStorage
- [ ] All share operations go through consent gate
- [ ] Capsule builder applies redactions
- [ ] BLE advertising is off by default

### Testing Reminders

- [ ] Check console for leaked content
- [ ] Verify SecureStore encryption on device
- [ ] Test consent gate appears before every share
- [ ] Confirm redactions work on test content
- [ ] Verify delete actually removes files
